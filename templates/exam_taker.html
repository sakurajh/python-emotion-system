<!--<!DOCTYPE html>-->
<!--<html lang="zh">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <title>Smart Exam // æ™ºèƒ½è€ƒåœº</title>-->
<!--    <script src="https://cdn.tailwindcss.com"></script>-->
<!--    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>-->
<!--    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>-->
<!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">-->
<!--    <style>-->
<!--        body { background: #f1f5f9; color: #1e293b; font-family: sans-serif; height: 100vh; overflow: hidden; }-->
<!--        .monitor-panel { background: #0f172a; color: #fff; }-->
<!--        /* ç­”é¢˜åŒºæ»šåŠ¨æ¡ */-->
<!--        .paper-scroll::-webkit-scrollbar { width: 6px; }-->
<!--        .paper-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }-->
<!--    </style>-->
<!--</head>-->
<!--<body class="flex">-->

<!--    &lt;!&ndash; å·¦ä¾§ï¼šè¯•å·åŒºåŸŸ &ndash;&gt;-->
<!--    <div class="w-2/3 h-full flex flex-col bg-white shadow-xl relative z-10">-->
<!--        &lt;!&ndash; è¯•å·å¤´ &ndash;&gt;-->
<!--        <div class="p-8 border-b border-gray-200">-->
<!--            <h1 class="text-3xl font-bold text-gray-800 mb-2" id="exam-title-display">æ­£åœ¨åŠ è½½è¯•å·...</h1>-->
<!--            <div class="flex gap-4 text-sm text-gray-500">-->
<!--                <span><i class="fa-regular fa-user mr-1"></i> è€ƒç”Ÿ: <span id="student-name" class="font-bold text-black">Guest</span></span>-->
<!--                <span><i class="fa-regular fa-clock mr-1"></i> ç”¨æ—¶: <span id="timer" class="font-mono font-bold text-blue-600">00:00:00</span></span>-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; é¢˜ç›®åˆ—è¡¨ &ndash;&gt;-->
<!--        <div id="paper-content" class="flex-1 overflow-y-auto p-8 paper-scroll space-y-8">-->
<!--            &lt;!&ndash; é¢˜ç›®ç”± JS æ¸²æŸ“ &ndash;&gt;-->
<!--        </div>-->

<!--        &lt;!&ndash; åº•éƒ¨ &ndash;&gt;-->
<!--        <div class="p-6 border-t border-gray-200 bg-gray-50 flex justify-between items-center">-->
<!--            <span class="text-xs text-gray-400">FaceSense Anti-Cheating System Active</span>-->
<!--            <button onclick="submitExam()" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg transition transform hover:-translate-y-1">-->
<!--                æäº¤ç­”å·-->
<!--            </button>-->
<!--        </div>-->
<!--    </div>-->

<!--    &lt;!&ndash; å³ä¾§ï¼šç›‘è€ƒä¸AIåˆ†æ &ndash;&gt;-->
<!--    <div class="w-1/3 h-full monitor-panel flex flex-col p-6 border-l-4 border-cyan-500">-->
<!--        <h2 class="text-cyan-400 font-bold tracking-widest mb-4 flex items-center gap-2">-->
<!--            <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span> å®æ—¶ç›‘è€ƒç»ˆç«¯-->
<!--        </h2>-->

<!--        &lt;!&ndash; æ‘„åƒå¤´ç”»é¢ &ndash;&gt;-->
<!--        <div class="relative rounded-xl overflow-hidden border border-cyan-500/30 bg-black aspect-video mb-6">-->
<!--            <img src="/video_feed" class="w-full h-full object-cover opacity-90">-->
<!--            <div class="absolute top-2 right-2 text-[10px] text-green-400 font-mono">LIVE FEED</div>-->

<!--            &lt;!&ndash; å®æ—¶çŠ¶æ€æ ‡ç­¾ &ndash;&gt;-->
<!--            <div class="absolute bottom-0 left-0 w-full bg-black/60 backdrop-blur p-2 flex justify-between">-->
<!--                <span class="text-xs text-gray-300">å½“å‰æƒ…ç»ª: <b id="curr-emo" class="text-white">Analyzing...</b></span>-->
<!--                <span class="text-xs text-gray-300">ä¸“æ³¨åº¦: <b id="curr-focus" class="text-cyan-400">&#45;&#45;</b></span>-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; ä¸“æ³¨åº¦æ›²çº¿ &ndash;&gt;-->
<!--        <div class="flex-1 bg-slate-800/50 rounded-xl border border-slate-700 p-2 relative">-->
<!--            <h3 class="text-xs text-gray-500 absolute top-2 left-2">ATTENTION SPAN HISTORY</h3>-->
<!--            <div id="focus-chart" class="w-full h-full"></div>-->
<!--        </div>-->

<!--        &lt;!&ndash; è­¦å‘Šæ—¥å¿— &ndash;&gt;-->
<!--        <div class="mt-4 h-32 bg-black rounded-lg p-3 font-mono text-[10px] overflow-y-auto text-gray-500 space-y-1" id="exam-logs">-->
<!--            <div class="text-green-600">>>> è€ƒè¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ</div>-->
<!--            <div class="text-cyan-600">>>> é¢éƒ¨ç‰¹å¾ç‚¹é”å®š</div>-->
<!--        </div>-->
<!--    </div>-->

<!--    <script>-->
<!--        // -&#45;&#45; 1. è·å–è¯•å·æ•°æ® -&#45;&#45;-->
<!--        // Jinja2 æ¨¡æ¿æ³¨å…¥-->
<!--        const examTitle = "{{ exam_title }}";-->
<!--        const questionsRaw = `{{ exam_questions | safe }}`;-->

<!--        let questions = [];-->
<!--        try {-->
<!--            questions = JSON.parse(questionsRaw || '[]');-->
<!--        } catch (e) {-->
<!--            console.error("é¢˜ç›®è§£æå¤±è´¥", e);-->
<!--            Swal.fire("é”™è¯¯", "è¯•å·æ•°æ®æŸå", "error");-->
<!--        }-->

<!--        const examId = "{{ exam_id }}";-->

<!--        let startTime = Date.now();-->
<!--        let emotionLogs = []; // è®°å½•å…¨ç¨‹æƒ…ç»ª-->
<!--        let focusScore = 80;  // åˆå§‹åˆ†-->

<!--        // æ¸²æŸ“é¡µé¢-->
<!--        document.getElementById('exam-title-display').innerText = examTitle;-->
<!--        const paper = document.getElementById('paper-content');-->

<!--        questions.forEach((q, idx) => {-->
<!--            const box = document.createElement('div');-->
<!--            box.className = "bg-white p-6 rounded-xl border border-gray-200 shadow-sm transition hover:shadow-md";-->

<!--            let html = `<h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2"><span class="text-blue-500 mr-2 font-mono">Q${idx+1}.</span> ${q.title}</h3>`;-->

<!--            if(q.type === 'choice') {-->
<!--                // ============================================-->
<!--                // ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½åˆ†å‰²é€»è¾‘-->
<!--                // ============================================-->
<!--                let opts = [];-->
<!--                const rawOpts = q.options || "";-->

<!--                if (rawOpts.includes('$$')) {-->
<!--                    // æ–¹æ¡ˆ Aï¼šä¼˜å…ˆæ£€æµ‹ $$ (AI å¯¼å…¥çš„æ•°å­¦é¢˜ä¸“ç”¨)-->
<!--                    // è¿™æ ·å³ä½¿å†…å®¹é‡Œæœ‰é€—å· (1,0) ä¹Ÿä¸ä¼šè¢«åˆ‡æ–­-->
<!--                    opts = rawOpts.split('$$');-->
<!--                } else if (rawOpts.includes('ï¼Œ')) {-->
<!--                    // æ–¹æ¡ˆ Bï¼šè€å¸ˆæ‰‹åŠ¨è¾“å…¥çš„ä¸­æ–‡é€—å·-->
<!--                    opts = rawOpts.split('ï¼Œ');-->
<!--                } else {-->
<!--                    // æ–¹æ¡ˆ Cï¼šæœ€åçš„æ‰‹æ®µï¼Œè‹±æ–‡é€—å· (å¯¹äºæ•°å­¦é¢˜è¿™æ­¥æ˜¯å±é™©çš„ï¼Œä½†æœ‰äº†æ–¹æ¡ˆAï¼Œæ•°å­¦é¢˜ä¸ä¼šèµ°åˆ°è¿™ä¸€æ­¥)-->
<!--                    opts = rawOpts.split(',');-->
<!--                }-->

<!--                // æ¸²æŸ“é€‰é¡¹-->
<!--                html += `<div class="space-y-3">`;-->
<!--                opts.forEach(opt => {-->
<!--                    const cleanOpt = opt.trim();-->
<!--                    if(cleanOpt) {-->
<!--                        html += `-->
<!--                            <label class="flex items-center p-3 rounded-lg border border-gray-100 hover:bg-blue-50 hover:border-blue-200 cursor-pointer transition group">-->
<!--                                <div class="relative flex items-center justify-center w-5 h-5 mr-3">-->
<!--                                    <input type="radio" name="q_${idx}" value="${cleanOpt}" class="peer appearance-none w-5 h-5 border-2 border-gray-300 rounded-full checked:border-blue-500 checked:bg-blue-500 transition-all">-->
<!--                                    <div class="absolute w-2 h-2 bg-white rounded-full opacity-0 peer-checked:opacity-100 transition-opacity"></div>-->
<!--                                </div>-->
<!--                                <span class="text-gray-700 group-hover:text-blue-700 text-sm md:text-base">${cleanOpt}</span>-->
<!--                            </label>`;-->
<!--                    }-->
<!--                });-->
<!--                html += `</div>`;-->

<!--            } else if (q.type === 'text') {-->
<!--                html += `<textarea name="q_${idx}" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-4 text-sm focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none transition resize-none" rows="4" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ç­”æ¡ˆ..."></textarea>`;-->
<!--            } else if (q.type === 'photo') {-->
<!--                html += `<div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50/50 transition group">-->
<!--                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-blue-100 transition">-->
<!--                                <i class="fa-solid fa-camera text-xl text-gray-400 group-hover:text-blue-500"></i>-->
<!--                            </div>-->
<!--                            <p class="text-sm font-bold text-gray-600 group-hover:text-blue-600">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–æ‹ç…§</p>-->
<!--                            <p class="text-xs text-gray-400 mt-1">æ”¯æŒ JPG, PNG æ ¼å¼</p>-->
<!--                            <input type="file" name="q_${idx}" class="hidden">-->
<!--                         </div>`;-->
<!--            }-->
<!--            box.innerHTML = html;-->
<!--            paper.appendChild(box);-->
<!--        });-->

<!--        // -&#45;&#45; 2. å®æ—¶ç›‘æ§é€»è¾‘ -&#45;&#45;-->
<!--        const chart = echarts.init(document.getElementById('focus-chart'));-->
<!--        const chartOption = {-->
<!--            grid: { top: 10, bottom: 0, left: 0, right: 0 },-->
<!--            xAxis: { type: 'category', show: false, data: [] },-->
<!--            yAxis: { type: 'value', min: 0, max: 100, show: false },-->
<!--            series: [{-->
<!--                type: 'line',-->
<!--                data: [],-->
<!--                smooth: true,-->
<!--                showSymbol: false,-->
<!--                lineStyle: { color: '#22d3ee', width: 2 },-->
<!--                areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(34,211,238,0.3)'},{offset:1,color:'transparent'}]) }-->
<!--            }]-->
<!--        };-->
<!--        const chartData = [];-->

<!--        // å®šæ—¶å™¨ï¼šæ¯ç§’è·å–æƒ…ç»ªæ•°æ®-->
<!--        setInterval(async () => {-->
<!--            try {-->
<!--                // æ›´æ–°æ—¶é—´-->
<!--                const elapsed = Math.floor((Date.now() - startTime) / 1000);-->
<!--                const h = Math.floor(elapsed / 3600).toString().padStart(2,'0');-->
<!--                const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2,'0');-->
<!--                const s = (elapsed % 60).toString().padStart(2,'0');-->
<!--                document.getElementById('timer').innerText = `${h}:${m}:${s}`;-->

<!--                // è·å– AI æ•°æ®-->
<!--                const res = await fetch('/api/get_data');-->
<!--                const data = await res.json();-->
<!--                const emos = data.emotions;-->

<!--                // ç®€å•çš„ä¸“æ³¨åº¦ç®—æ³•-->
<!--                let currentScore = (emos['å¹³é™'] * 1.0 + emos['å–œæ‚¦'] * 0.5 + emos['æƒŠè®¶'] * 0.8 + 10); // åŸºç¡€åˆ†è¡¥å¿-->
<!--                currentScore = Math.min(100, Math.max(0, currentScore));-->

<!--                // æ›´æ–° UI-->
<!--                const topEmo = Object.keys(emos).reduce((a, b) => emos[a] > emos[b] ? a : b);-->
<!--                document.getElementById('curr-emo').innerText = topEmo;-->

<!--                const focusEl = document.getElementById('curr-focus');-->
<!--                focusEl.innerText = currentScore.toFixed(0);-->
<!--                focusEl.className = currentScore > 60 ? "text-green-400 font-bold" : "text-red-500 font-bold animate-pulse";-->

<!--                // æ›´æ–°å›¾è¡¨-->
<!--                chartData.push(currentScore);-->
<!--                if(chartData.length > 50) chartData.shift();-->
<!--                chartOption.series[0].data = chartData;-->
<!--                chart.setOption(chartOption);-->

<!--                // è®°å½•æ—¥å¿—-->
<!--                emotionLogs.push({ time: elapsed, emo: topEmo, score: currentScore });-->

<!--                // å¼‚å¸¸æ£€æµ‹æ—¥å¿—-->
<!--                if(currentScore < 40 && Math.random() > 0.7) {-->
<!--                    const logBox = document.getElementById('exam-logs');-->
<!--                    const div = document.createElement('div');-->
<!--                    div.className = "text-red-400 border-l-2 border-red-500 pl-2 mb-1";-->
<!--                    div.innerText = `[${new Date().toLocaleTimeString()}] âš ï¸ ä¸“æ³¨åº¦è¿‡ä½ (${currentScore.toFixed(0)}%)`;-->
<!--                    logBox.prepend(div);-->
<!--                }-->

<!--            } catch(e) {}-->
<!--        }, 1000);-->

<!--        window.onresize = () => chart.resize();-->

<!--        // -&#45;&#45; 3. æäº¤è¯•å· -&#45;&#45;-->
<!--        async function submitExam() {-->
<!--            const { value: studentName } = await Swal.fire({-->
<!--                title: 'æäº¤ç­”å·',-->
<!--                input: 'text',-->
<!--                inputLabel: 'è¯·è¾“å…¥æ‚¨çš„å§“å',-->
<!--                inputPlaceholder: 'ä¾‹å¦‚ï¼šå¼ ä¸‰',-->
<!--                showCancelButton: true,-->
<!--                confirmButtonColor: '#2563eb',-->
<!--                background: '#f8fafc',-->
<!--                color: '#1e293b'-->
<!--            });-->

<!--            if(!studentName) return;-->

<!--            // æ”¶é›†ç­”æ¡ˆ (ç®€å•æ¼”ç¤ºæ”¶é›† text å’Œ radio)-->
<!--            const answers = {};-->
<!--            // å®é™…é€»è¾‘ï¼šéå† questionsï¼Œæ ¹æ® name è·å– value-->

<!--            // è®¡ç®—å¹³å‡ä¸“æ³¨åº¦-->
<!--            const avgFocus = emotionLogs.length ? (emotionLogs.reduce((acc, curr) => acc + curr.score, 0) / emotionLogs.length) : 80;-->

<!--            const formData = new FormData();-->
<!--            formData.append('exam_id', examId);-->
<!--            formData.append('student_name', studentName);-->
<!--            formData.append('answers', JSON.stringify(answers));-->
<!--            formData.append('emotion_log', JSON.stringify(emotionLogs));-->
<!--            formData.append('avg_score', avgFocus.toFixed(1));-->

<!--            Swal.fire({ title: 'æ­£åœ¨åŠ å¯†ä¸Šä¼ ...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });-->

<!--            try {-->
<!--                const res = await fetch('/api/exam/submit', { method: 'POST', body: formData });-->
<!--                const data = await res.json();-->

<!--                if(data.status === 'success') {-->
<!--                    Swal.fire({-->
<!--                        icon: 'success',-->
<!--                        title: 'è€ƒè¯•ç»“æŸ',-->
<!--                        html: `<p class="mb-4 text-gray-600">${data.ai_comment}</p><p class="text-sm text-gray-400">çª—å£å³å°†å…³é—­</p>`,-->
<!--                        timer: 5000,-->
<!--                        timerProgressBar: true-->
<!--                    }).then(() => window.location.href='/');-->
<!--                }-->
<!--            } catch(e) {-->
<!--                Swal.fire('æäº¤å¤±è´¥', e.message, 'error');-->
<!--            }-->
<!--        }-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->



<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Smart Exam // æ™ºèƒ½è€ƒåœº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f1f5f9; color: #1e293b; font-family: sans-serif; height: 100vh; overflow: hidden; }
        .monitor-panel { background: #0f172a; color: #fff; }
        /* ç­”é¢˜åŒºæ»šåŠ¨æ¡ */
        .paper-scroll::-webkit-scrollbar { width: 6px; }
        .paper-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="flex">

    <!-- å·¦ä¾§ï¼šè¯•å·åŒºåŸŸ -->
    <div class="w-2/3 h-full flex flex-col bg-white shadow-xl relative z-10">
        <!-- è¯•å·å¤´ -->
        <div class="p-8 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800 mb-2" id="exam-title-display">æ­£åœ¨åŠ è½½è¯•å·...</h1>
            <div class="flex gap-4 text-sm text-gray-500">
                <span><i class="fa-regular fa-user mr-1"></i> è€ƒç”Ÿ: <span id="student-name" class="font-bold text-black">Guest</span></span>
                <span><i class="fa-regular fa-clock mr-1"></i> ç”¨æ—¶: <span id="timer" class="font-mono font-bold text-blue-600">00:00:00</span></span>
            </div>
        </div>

        <!-- é¢˜ç›®åˆ—è¡¨ -->
        <div id="paper-content" class="flex-1 overflow-y-auto p-8 paper-scroll space-y-8">
            <!-- é¢˜ç›®ç”± JS æ¸²æŸ“ -->
        </div>

        <!-- åº•éƒ¨ -->
        <div class="p-6 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
            <span class="text-xs text-gray-400">FaceSense Anti-Cheating System Active</span>
            <button onclick="submitExam()" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg transition transform hover:-translate-y-1">
                æäº¤ç­”å·
            </button>
        </div>
    </div>

    <!-- å³ä¾§ï¼šç›‘è€ƒä¸AIåˆ†æ -->
    <div class="w-1/3 h-full monitor-panel flex flex-col p-6 border-l-4 border-cyan-500">
        <h2 class="text-cyan-400 font-bold tracking-widest mb-4 flex items-center gap-2">
            <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span> å®æ—¶ç›‘è€ƒç»ˆç«¯
        </h2>

        <!-- æ‘„åƒå¤´ç”»é¢ -->
        <div class="relative rounded-xl overflow-hidden border border-cyan-500/30 bg-black aspect-video mb-6">
            <!-- è°ƒç”¨ main.py çš„è§†é¢‘æµæ¥å£ -->
            <img src="/video_feed" class="w-full h-full object-cover opacity-90">
            <div class="absolute top-2 right-2 text-[10px] text-green-400 font-mono">LIVE FEED</div>

            <!-- å®æ—¶çŠ¶æ€æ ‡ç­¾ -->
            <div class="absolute bottom-0 left-0 w-full bg-black/60 backdrop-blur p-2 flex justify-between">
                <span class="text-xs text-gray-300">å½“å‰æƒ…ç»ª: <b id="curr-emo" class="text-white">Analyzing...</b></span>
                <span class="text-xs text-gray-300">ä¸“æ³¨åº¦: <b id="curr-focus" class="text-cyan-400">--</b></span>
            </div>
        </div>

        <!-- ä¸“æ³¨åº¦æ›²çº¿ -->
        <div class="flex-1 bg-slate-800/50 rounded-xl border border-slate-700 p-2 relative">
            <h3 class="text-xs text-gray-500 absolute top-2 left-2">ATTENTION SPAN HISTORY</h3>
            <div id="focus-chart" class="w-full h-full"></div>
        </div>

        <!-- è­¦å‘Šæ—¥å¿— -->
        <div class="mt-4 h-32 bg-black rounded-lg p-3 font-mono text-[10px] overflow-y-auto text-gray-500 space-y-1" id="exam-logs">
            <div class="text-green-600">>>> è€ƒè¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ</div>
            <div class="text-cyan-600">>>> é¢éƒ¨ç‰¹å¾ç‚¹é”å®š</div>
        </div>
    </div>

    <script>
        // --- 1. è·å–åç«¯ä¼ æ¥çš„è¯•å·æ•°æ® ---
        const examTitle = "{{ exam_title }}";
        const questionsRaw = `{{ exam_questions | safe }}`;

        let questions = [];
        try {
            questions = JSON.parse(questionsRaw || '[]');
        } catch (e) {
            console.error("é¢˜ç›®è§£æå¤±è´¥", e);
            Swal.fire("é”™è¯¯", "è¯•å·æ•°æ®æŸå", "error");
        }

        const examId = "{{ exam_id }}";

        let startTime = Date.now();
        let emotionLogs = []; // è®°å½•å…¨ç¨‹æƒ…ç»ª
        let focusScore = 80;  // åˆå§‹åˆ†

        // æ¸²æŸ“é¡µé¢
        document.getElementById('exam-title-display').innerText = examTitle;
        const paper = document.getElementById('paper-content');

        questions.forEach((q, idx) => {
            const box = document.createElement('div');
            box.className = "bg-white p-6 rounded-xl border border-gray-200 shadow-sm transition hover:shadow-md";

            let html = `<h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2"><span class="text-blue-500 mr-2 font-mono">Q${idx+1}.</span> ${q.title}</h3>`;

            if(q.type === 'choice') {
                // ğŸŸ¢ æ™ºèƒ½åˆ†å‰²é€»è¾‘ï¼šä¼˜å…ˆå¤„ç†æ•°å­¦é¢˜ $$ï¼Œå…¶æ¬¡ä¸­æ–‡é€—å·ï¼Œæœ€åè‹±æ–‡é€—å·
                let opts = [];
                const rawOpts = q.options || "";

                if (rawOpts.includes('$$')) {
                    opts = rawOpts.split('$$');
                } else if (rawOpts.includes('ï¼Œ')) {
                    opts = rawOpts.split('ï¼Œ');
                } else {
                    opts = rawOpts.split(',');
                }

                html += `<div class="space-y-3">`;
                opts.forEach(opt => {
                    const cleanOpt = opt.trim();
                    if(cleanOpt) {
                        html += `
                            <label class="flex items-center p-3 rounded-lg border border-gray-100 hover:bg-blue-50 hover:border-blue-200 cursor-pointer transition group">
                                <div class="relative flex items-center justify-center w-5 h-5 mr-3">
                                    <input type="radio" name="q_${idx}" value="${cleanOpt}" class="peer appearance-none w-5 h-5 border-2 border-gray-300 rounded-full checked:border-blue-500 checked:bg-blue-500 transition-all">
                                    <div class="absolute w-2 h-2 bg-white rounded-full opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                </div>
                                <span class="text-gray-700 group-hover:text-blue-700 text-sm md:text-base">${cleanOpt}</span>
                            </label>`;
                    }
                });
                html += `</div>`;

            } else if (q.type === 'text') {
                html += `<textarea name="q_${idx}" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-4 text-sm focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none transition resize-none" rows="4" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ç­”æ¡ˆ..."></textarea>`;
            } else if (q.type === 'photo') {
                html += `<div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50/50 transition group">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-blue-100 transition">
                                <i class="fa-solid fa-camera text-xl text-gray-400 group-hover:text-blue-500"></i>
                            </div>
                            <p class="text-sm font-bold text-gray-600 group-hover:text-blue-600">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–æ‹ç…§</p>
                            <p class="text-xs text-gray-400 mt-1">æ”¯æŒ JPG, PNG æ ¼å¼</p>
                            <input type="file" name="q_${idx}" class="hidden">
                         </div>`;
            }
            box.innerHTML = html;
            paper.appendChild(box);
        });

        // --- 2. å®æ—¶ç›‘æ§é€»è¾‘ ---
        const chart = echarts.init(document.getElementById('focus-chart'));
        const chartOption = {
            grid: { top: 10, bottom: 0, left: 0, right: 0 },
            xAxis: { type: 'category', show: false, data: [] },
            yAxis: { type: 'value', min: 0, max: 100, show: false },
            series: [{
                type: 'line',
                data: [],
                smooth: true,
                showSymbol: false,
                lineStyle: { color: '#22d3ee', width: 2 },
                areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(34,211,238,0.3)'},{offset:1,color:'transparent'}]) }
            }]
        };
        const chartData = [];

        // æ¯ç§’åŒæ­¥æƒ…ç»ªæ•°æ®
        setInterval(async () => {
            try {
                // æ›´æ–°è®¡æ—¶å™¨
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const h = Math.floor(elapsed / 3600).toString().padStart(2,'0');
                const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2,'0');
                const s = (elapsed % 60).toString().padStart(2,'0');
                document.getElementById('timer').innerText = `${h}:${m}:${s}`;

                // ä»åç«¯ API è·å–å®æ—¶æƒ…ç»ª
                const res = await fetch('/api/get_data');
                const data = await res.json();
                const emos = data.emotions;

                // è®¡ç®—ä¸“æ³¨åº¦ (ç®€å•ç®—æ³•)
                let currentScore = (emos['å¹³é™'] * 1.0 + emos['å–œæ‚¦'] * 0.5 + emos['æƒŠè®¶'] * 0.8 + 10);
                currentScore = Math.min(100, Math.max(0, currentScore));

                // æ›´æ–°å³ä¾§é¢æ¿ UI
                const topEmo = Object.keys(emos).reduce((a, b) => emos[a] > emos[b] ? a : b);
                document.getElementById('curr-emo').innerText = topEmo;

                const focusEl = document.getElementById('curr-focus');
                focusEl.innerText = currentScore.toFixed(0);
                focusEl.className = currentScore > 60 ? "text-green-400 font-bold" : "text-red-500 font-bold animate-pulse";

                // æ›´æ–°å›¾è¡¨
                chartData.push(currentScore);
                if(chartData.length > 50) chartData.shift();
                chartOption.series[0].data = chartData;
                chart.setOption(chartOption);

                // è®°å½•æ•°æ®ä¾›æäº¤
                emotionLogs.push({ time: elapsed, emo: topEmo, score: currentScore });

                // å¼‚å¸¸æ£€æµ‹æ—¥å¿—
                if(currentScore < 40 && Math.random() > 0.7) {
                    const logBox = document.getElementById('exam-logs');
                    const div = document.createElement('div');
                    div.className = "text-red-400 border-l-2 border-red-500 pl-2 mb-1";
                    div.innerText = `[${new Date().toLocaleTimeString()}] âš ï¸ ä¸“æ³¨åº¦è¿‡ä½ (${currentScore.toFixed(0)}%)`;
                    logBox.prepend(div);
                }

            } catch(e) {}
        }, 1000);

        window.onresize = () => chart.resize();

        // --- 3. æäº¤è¯•å· (å®Œæ•´ç‰ˆ) ---
        async function submitExam() {
            const { value: studentName } = await Swal.fire({
                title: 'æäº¤ç­”å·',
                input: 'text',
                inputLabel: 'è¯·è¾“å…¥æ‚¨çš„å§“å',
                inputPlaceholder: 'ä¾‹å¦‚ï¼šå¼ ä¸‰',
                showCancelButton: true,
                confirmButtonColor: '#2563eb',
                background: '#f8fafc',
                color: '#1e293b'
            });

            if(!studentName) return;

            // ğŸŸ¢ æ”¶é›†ç­”æ¡ˆï¼šæŠŠ é¢˜ç›®->ç­”æ¡ˆ å¯¹åº”èµ·æ¥ï¼Œæ–¹ä¾¿è€å¸ˆçœ‹
            const answers = {};
            questions.forEach((q, idx) => {
                const key = `Q${idx+1}. ${q.title}`; // é¢˜ç›®ä½œä¸º Key
                let val = "æœªä½œç­”";

                if (q.type === 'choice') {
                    const selected = document.querySelector(`input[name="q_${idx}"]:checked`);
                    if (selected) val = selected.value;
                } else if (q.type === 'text') {
                    const text = document.querySelector(`textarea[name="q_${idx}"]`);
                    if (text && text.value.trim()) val = text.value.trim();
                } else if (q.type === 'photo') {
                    const fileInput = document.querySelector(`input[name="q_${idx}"]`);
                    if (fileInput && fileInput.files.length > 0) val = "[å›¾ç‰‡å·²ä¸Šä¼ ]";
                }
                answers[key] = val;
            });

            // è®¡ç®—æ•´åœºè€ƒè¯•çš„å¹³å‡ä¸“æ³¨åº¦
            const avgFocus = emotionLogs.length ? (emotionLogs.reduce((acc, curr) => acc + curr.score, 0) / emotionLogs.length) : 80;

            const formData = new FormData();
            formData.append('exam_id', examId);
            formData.append('student_name', studentName);
            formData.append('answers', JSON.stringify(answers));
            formData.append('emotion_log', JSON.stringify(emotionLogs));
            formData.append('avg_score', avgFocus.toFixed(1));

            Swal.fire({ title: 'æ­£åœ¨åŠ å¯†ä¸Šä¼ ...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

            try {
                const res = await fetch('/api/exam/submit', { method: 'POST', body: formData });
                const data = await res.json();

                if(data.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'è€ƒè¯•ç»“æŸ',
                        html: `<p class="mb-4 text-gray-600">${data.ai_comment}</p><p class="text-sm text-gray-400">çª—å£å³å°†å…³é—­</p>`,
                        timer: 5000,
                        timerProgressBar: true
                    }).then(() => window.location.href='/student/dashboard'); // è¿”å›å¤§å…
                }
            } catch(e) {
                Swal.fire('æäº¤å¤±è´¥', e.message, 'error');
            }
        }
    </script>
</body>
</html>



