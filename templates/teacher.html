<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>EDU-MATRIX // æ•™å­¦æŒ‡æŒ¥èˆ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- å¼•å…¥ FontAwesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');
        body { background: #0f172a; color: #e2e8f0; font-family: 'Rajdhani', sans-serif; height: 100vh; overflow: hidden; }

        /* ç§‘æŠ€æ„Ÿè¾¹æ¡† */
        .cyber-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(56, 189, 248, 0.2);
            backdrop-filter: blur(10px);
            position: relative;
            border-radius: 8px;
        }
        .cyber-card::after {
            content: ''; position: absolute; bottom: 0; right: 0; width: 20px; height: 20px;
            border-bottom: 2px solid #38bdf8; border-right: 2px solid #38bdf8;
            border-radius: 0 0 8px 0;
        }

        /* å­¦ç”Ÿåº§ä½æ ¼ */
        .student-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; }
        .seat {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .seat:hover { transform: scale(1.05); border-color: #38bdf8; box-shadow: 0 0 15px rgba(56,189,248,0.3); }
        .seat.focus { border-color: #22c55e; box-shadow: inset 0 0 10px rgba(34,197,94,0.2); }
        .seat.bored { border-color: #eab308; box-shadow: inset 0 0 10px rgba(234,179,8,0.2); }
        .seat.distracted { border-color: #ef4444; box-shadow: inset 0 0 10px rgba(239,68,68,0.2); }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="p-4 flex flex-col gap-4">

    <!-- é¡¶æ  -->
    <header class="cyber-card p-4 flex justify-between items-center h-16">
        <div class="flex items-center gap-4">
            <i class="fa-solid fa-graduation-cap text-3xl text-cyan-400"></i>
            <div>
                <h1 class="text-2xl font-bold tracking-widest text-white">EDU-MATRIX <span class="text-cyan-500 text-sm">// CLASSROOM_ANALYTICS</span></h1>
            </div>
        </div>
        <div class="flex gap-6 text-sm font-mono">
            <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> <span class="text-gray-400">STATUS:</span> <span class="text-green-400">RECORDING</span></div>
            <div class="flex items-center gap-2"><i class="fa-regular fa-clock text-cyan-500"></i> <span id="class-timer">00:00:00</span></div>
            <button onclick="window.location.href='/'" class="bg-red-900/30 text-red-400 px-4 py-1 rounded border border-red-800 hover:bg-red-600 hover:text-white transition text-xs">EXIT</button>
        </div>
    </header>

    <div class="grid grid-cols-12 gap-4 flex-1 min-h-0">

        <!-- å·¦ä¾§ï¼šç­çº§æ¦‚è§ˆ + AI æŠ¥å‘Š -->
        <div class="col-span-4 flex flex-col gap-4">
            <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
            <div class="cyber-card p-6 h-1/3 flex flex-col justify-center gap-6">
                <div class="flex justify-between items-end">
                    <span class="text-gray-400 text-sm uppercase tracking-widest">Engagement Index</span>
                    <span id="score-val" class="text-5xl font-bold text-cyan-400">87.5</span>
                </div>
                <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                    <div id="score-bar" class="bg-gradient-to-r from-cyan-600 to-blue-400 h-full transition-all duration-1000" style="width: 87.5%"></div>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center text-xs mt-2">
                    <div class="bg-white/5 p-2 rounded"><div class="text-green-400 text-lg font-bold" id="happy-count">12</div><div class="text-gray-500">ä¸“æ³¨/å–œæ‚¦</div></div>
                    <div class="bg-white/5 p-2 rounded"><div class="text-yellow-400 text-lg font-bold" id="bored-count">5</div><div class="text-gray-500">å›°å€¦/å¹³é™</div></div>
                    <div class="bg-white/5 p-2 rounded"><div class="text-red-400 text-lg font-bold" id="distracted-count">3</div><div class="text-gray-500">åˆ†å¿ƒ/ç–‘æƒ‘</div></div>
                </div>
            </div>

            <!-- AI æŠ¥å‘ŠåŒº (æ ¸å¿ƒåŠŸèƒ½) -->
            <div class="cyber-card flex-1 flex flex-col p-4 relative overflow-hidden">
                <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                    <h3 class="text-cyan-400 font-bold tracking-widest"><i class="fa-solid fa-robot mr-2"></i>AI æ•™å­¦é¡¾é—®</h3>
                    <button onclick="generateReport()" class="bg-cyan-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-cyan-500 transition shadow-[0_0_15px_#06b6d4]">
                        ç”Ÿæˆæœ¬èŠ‚è¯¾æŠ¥å‘Š
                    </button>
                </div>
                <div id="ai-report-content" class="flex-1 overflow-y-auto font-mono text-sm text-gray-300 leading-relaxed pr-2">
                    <div class="flex flex-col items-center justify-center h-full text-gray-600 gap-2 opacity-50">
                        <i class="fa-solid fa-microchip text-4xl"></i>
                        <p>ç­‰å¾…æ•°æ®è¾“å…¥...</p>
                    </div>
                </div>
                <!-- åŠ è½½åŠ¨ç”» -->
                <div id="ai-loading" class="absolute inset-0 bg-slate-900/90 hidden items-center justify-center flex-col z-20">
                    <div class="w-10 h-10 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-cyan-400 text-xs animate-pulse">æ­£åœ¨åˆ†æå…¨ç­å¾®è¡¨æƒ…æ•°æ®...</p>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´ï¼šè™šæ‹Ÿåº§ä½è¡¨ (æ¨¡æ‹Ÿå…¨ç­) -->
        <div class="col-span-8 flex flex-col gap-4">
            <!-- æ¨¡æ‹Ÿæ•°æ®å¯¼å…¥æ  -->
            <div class="cyber-card p-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-gray-400 text-xs uppercase">DATA SOURCE:</span>
                    <select class="bg-slate-800 border border-slate-600 text-xs rounded px-2 py-1 text-white focus:border-cyan-500 outline-none">
                        <option>CAM_01 (Classroom Front)</option>
                        <option>Video_Import.mp4</option>
                    </select>
                    <button onclick="startSimulation()" class="text-green-400 text-xs border border-green-500/30 px-3 py-1 rounded hover:bg-green-500/10">
                        <i class="fa-solid fa-play mr-1"></i> å¼€å§‹ä¸Šè¯¾
                    </button>
                </div>
                <div class="flex gap-4 text-xs text-gray-500">
                    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> ä¸“æ³¨</div>
                    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> å›°å€¦</div>
                    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> åˆ†å¿ƒ</div>
                </div>
            </div>

            <!-- åº§ä½çŸ©é˜µ -->
            <div class="cyber-card p-6 flex-1 overflow-y-auto">
                <div class="student-grid" id="seat-grid">
                    <!-- å­¦ç”Ÿåº§ä½ç”± JS ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ä¸“æ³¨åº¦æ›²çº¿ -->
            <div class="cyber-card p-4 h-48">
                <div id="trend-chart" class="w-full h-full"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. åˆå§‹åŒ–é…ç½® ---
        const studentCount = 24;
        let isSimulating = false;
        let timelineData = []; // å­˜å‚¨æ—¶é—´è½´æ•°æ®ç”¨äº AI åˆ†æ

        // åˆå§‹åŒ– ECharts
        const trendChart = echarts.init(document.getElementById('trend-chart'));
        const trendOption = {
            grid: { top: 10, bottom: 20, left: 30, right: 10 },
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'category', data: [], boundaryGap: false, axisLine:{lineStyle:{color:'#475569'}} },
            yAxis: { type: 'value', min: 0, max: 100, splitLine:{lineStyle:{color:'#1e293b'}}, axisLabel:{color:'#64748b'} },
            series: [{
                name: 'ä¸“æ³¨åº¦', type: 'line', smooth: true, symbol: 'none',
                lineStyle: { color: '#38bdf8', width: 3 },
                areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(56,189,248,0.3)'},{offset:1,color:'transparent'}]) },
                data: []
            }]
        };
        trendChart.setOption(trendOption);

        // --- 2. ç”Ÿæˆåº§ä½è¡¨ ---
        const grid = document.getElementById('seat-grid');
        for(let i=1; i<=studentCount; i++) {
            grid.innerHTML += `
                <div class="seat focus" id="stu-${i}">
                    <div class="text-xs text-gray-500 mb-2">SEAT ${i.toString().padStart(2,'0')}</div>
                    <div class="text-2xl mb-1" id="icon-${i}">ğŸ˜</div>
                    <div class="text-xs font-bold text-white" id="name-${i}">Student ${i}</div>
                    <div class="text-[10px] text-cyan-400 mt-1" id="stat-${i}">ä¸“æ³¨ 88%</div>
                </div>
            `;
        }

        // --- 3. æ¨¡æ‹Ÿé€»è¾‘ (Simulate AI Analysis) ---
        function startSimulation() {
            if(isSimulating) return;
            isSimulating = true;
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'æ•°æ®æµå·²æ¥å…¥', showConfirmButton: false, timer: 2000, background: '#1e293b', color: '#fff' });

            setInterval(() => {
                let totalScore = 0;
                let happy = 0, bored = 0, distracted = 0;

                // éå†æ¯ä¸ªå­¦ç”Ÿæ›´æ–°çŠ¶æ€
                for(let i=1; i<=studentCount; i++) {
                    const seat = document.getElementById(`stu-${i}`);
                    const icon = document.getElementById(`icon-${i}`);
                    const stat = document.getElementById(`stat-${i}`);

                    // éšæœºç”ŸæˆçŠ¶æ€ (åŠ æƒéšæœº)
                    const rand = Math.random();
                    let state = 'focus';
                    let score = 80 + Math.random() * 20;

                    if(rand > 0.85) { state = 'distracted'; score = Math.random() * 40; distracted++; }
                    else if(rand > 0.65) { state = 'bored'; score = 40 + Math.random() * 30; bored++; }
                    else { happy++; }

                    totalScore += score;

                    // æ›´æ–° UI
                    seat.className = `seat ${state}`;
                    if(state === 'focus') { icon.innerText = 'ğŸ§'; stat.innerText = `ä¸“æ³¨ ${score.toFixed(0)}%`; stat.className = 'text-[10px] text-green-400 mt-1'; }
                    else if(state === 'bored') { icon.innerText = 'ğŸ˜´'; stat.innerText = `å›°å€¦ ${score.toFixed(0)}%`; stat.className = 'text-[10px] text-yellow-400 mt-1'; }
                    else { icon.innerText = 'ğŸ˜’'; stat.innerText = `åˆ†å¿ƒ ${score.toFixed(0)}%`; stat.className = 'text-[10px] text-red-400 mt-1'; }
                }

                // æ›´æ–°æ•´ä½“æŒ‡æ ‡
                const avgScore = totalScore / studentCount;
                document.getElementById('score-val').innerText = avgScore.toFixed(1);
                document.getElementById('score-bar').style.width = avgScore + "%";
                document.getElementById('happy-count').innerText = happy;
                document.getElementById('bored-count').innerText = bored;
                document.getElementById('distracted-count').innerText = distracted;

                // æ›´æ–°å›¾è¡¨
                const now = new Date();
                const timeStr = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();

                // è®°å½•æ•°æ®ç»™ AI åˆ†æç”¨
                timelineData.push({ time: timeStr, score: avgScore.toFixed(1), bored_count: bored });
                if(timelineData.length > 20) timelineData.shift(); // ä¿æŒæ•°æ®æ–°é²œ

                trendOption.xAxis.data.push(timeStr);
                trendOption.series[0].data.push(avgScore);
                if(trendOption.xAxis.data.length > 20) {
                    trendOption.xAxis.data.shift();
                    trendOption.series[0].data.shift();
                }
                trendChart.setOption(trendOption);

            }, 1500); // æ¯ 1.5 ç§’åˆ·æ–°ä¸€æ¬¡
        }

        // --- 4. æ ¸å¿ƒï¼šè°ƒç”¨ AI ç”ŸæˆæŠ¥å‘Š ---
        async function generateReport() {
            if(!isSimulating) {
                Swal.fire({ icon: 'warning', title: 'æ— æ•°æ®', text: 'è¯·å…ˆå¼€å§‹æ¨¡æ‹Ÿæ¨æµä»¥è·å–æ•°æ®', background: '#1e293b', color: '#fff' });
                return;
            }

            const loading = document.getElementById('ai-loading');
            const content = document.getElementById('ai-report-content');

            loading.classList.remove('hidden');
            loading.classList.add('flex');

            try {
                // æ„é€ å‘ç»™åç«¯çš„ç»Ÿè®¡æ‘˜è¦
                const reportData = `
                    å½“å‰æ—¶é—´: ${new Date().toLocaleString()}
                    ç­çº§äººæ•°: ${studentCount}
                    å¹³å‡ä¸“æ³¨åº¦: ${document.getElementById('score-val').innerText}
                    å½“å‰çŠ¶æ€åˆ†å¸ƒ:
                    - ä¸“æ³¨: ${document.getElementById('happy-count').innerText} äºº
                    - å›°å€¦: ${document.getElementById('bored-count').innerText} äºº
                    - åˆ†å¿ƒ: ${document.getElementById('distracted-count').innerText} äºº
                    è¿‘æœŸè¶‹åŠ¿: ä¸“æ³¨åº¦åœ¨ ${timelineData[0].score} åˆ° ${timelineData[timelineData.length-1].score} ä¹‹é—´æ³¢åŠ¨ã€‚
                `;

                // å‘é€è¯·æ±‚ç»™ main.py
                const formData = new FormData();
                formData.append('data', reportData);

                const res = await fetch('/api/teacher/analyze_class', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                loading.classList.add('hidden');

                if(data.status === 'success') {
                    content.innerHTML = "";

                    // --- ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šæŠŠ Markdown ç¬¦å·è½¬æ¢æˆ HTML æ ‡ç­¾ ---
                    let mdText = data.report
                        .replace(/\n/g, '<br>')                          // 1. å¤„ç†æ¢è¡Œ
                        .replace(/\*\*(.*?)\*\*/g, '<b class="text-cyan-400 text-base">$1</b>') // 2. å¤„ç†åŠ ç²— (**æ–‡å­—** -> è“è‰²åŠ ç²—)
                        .replace(/###\s*(.*)/g, '<h3 class="text-lg font-bold text-white mt-4 mb-2 border-l-4 border-cyan-500 pl-2">$1</h3>'); // 3. å¤„ç†æ ‡é¢˜ (### æ ‡é¢˜ -> å¤§æ ‡é¢˜)

                    // æ‰“å­—æœºæ•ˆæœè¾“å‡º
                    let i = 0;
                    const typeInterval = setInterval(() => {
                        // æ¯æ¬¡æˆªå–ä¸€éƒ¨åˆ† HTML æ˜¾ç¤º
                        // æ³¨æ„ï¼šè¿™é‡Œç®€å•æˆªå–å¯èƒ½ä¼šæˆªæ–­æ ‡ç­¾ï¼Œä½†ä¸ºäº†è§†è§‰æ•ˆæœé€šå¸¸å½±å“ä¸å¤§
                        // ä¸ºäº†é˜²æ­¢æ ‡ç­¾æˆªæ–­å¯¼è‡´ä¹±ç ï¼Œæˆ‘ä»¬ç›´æ¥æ•´æ®µæ˜¾ç¤ºï¼Œæˆ–è€…ç”¨æ›´ç®€å•çš„é€»è¾‘

                        // æ–¹æ¡ˆ Bï¼šç›´æ¥ä¸€æ¬¡æ€§æ˜¾ç¤ºï¼ˆæœ€ç¨³å¦¥ï¼Œä¸ä¼šå¯¼è‡´ <b> æ ‡ç­¾åªæ˜¾ç¤ºä¸€åŠï¼‰
                        content.innerHTML = mdText;
                        content.scrollTop = content.scrollHeight;
                        clearInterval(typeInterval);

                    }, 10);
                } else {
                    content.innerHTML = `<span class="text-red-500">æŠ¥å‘Šç”Ÿæˆå¤±è´¥: ${data.message}</span>`;
                }
            } catch(e) {
                loading.classList.add('hidden');
                content.innerHTML = `<span class="text-red-500">ç½‘ç»œè¿æ¥é”™è¯¯: ${e.message}</span>`;
            }
        }

        // è®¡æ—¶å™¨
        setInterval(() => {
            const now = new Date();
            document.getElementById('class-timer').innerText = now.toLocaleTimeString();
        }, 1000);

        window.onresize = () => trendChart.resize();
    </script>
</body>
</html>