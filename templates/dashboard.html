<!--<!DOCTYPE html>-->
<!--<html lang="zh">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>-->
<!--    <link rel="icon" href="/static/ai_16x16.ico" type="image/x-icon">-->
<!--    <title>FaceSense AI | 全球顶尖情感分析终端</title>-->
<!--    <script src="https://cdn.tailwindcss.com"></script>-->
<!--    &lt;!&ndash; 引入强大的 ECharts 引擎 &ndash;&gt;-->
<!--    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>-->
<!--    <style>-->
<!--        body { background: #010409; color: #c9d1d9; overflow: hidden; height: 100vh; font-family: 'Consolas', monospace; }-->
<!--        .glass { background: rgba(13, 17, 23, 0.9); border: 1px solid rgba(56, 189, 248, 0.2); box-shadow: 0 0 20px rgba(0,0,0,0.5); }-->
<!--        .neon-border { border: 1px solid #06b6d4; box-shadow: 0 0 10px rgba(6, 182, 212, 0.4); }-->
<!--        .fui-grid { background-image: linear-gradient(rgba(6, 182, 212, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(6, 182, 212, 0.05) 1px, transparent 1px); background-size: 40px 40px; }-->
<!--        /* 扫描线动画 */-->
<!--        .scan-effect { position: absolute; inset: 0; pointer-events: none; background: linear-gradient(to bottom, transparent, rgba(6, 182, 212, 0.1), transparent); height: 10%; width: 100%; animation: scan 3s linear infinite; }-->
<!--        @keyframes scan { from { top: -10%; } to { top: 110%; } }-->
<!--    </style>-->
<!--</head>-->
<!--<body class="fui-grid p-4 flex flex-col">-->

<!--    &lt;!&ndash; 顶栏：系统指标 &ndash;&gt;-->
<!--    <header class="glass p-3 rounded-xl mb-4 flex justify-between items-center px-8 border-t-2 border-cyan-500">-->
<!--        <div class="flex items-center gap-4">-->
<!--            <div class="w-3 h-3 bg-red-600 rounded-full animate-pulse shadow-[0_0_10px_red]"></div>-->
<!--            <h1 class="text-xl font-black italic tracking-[0.2em] text-cyan-400">BIOMETRIC_DATA_LINK // V4.0</h1>-->
<!--        </div>-->
<!--        <div class="flex gap-12 text-[10px] uppercase font-bold text-gray-400">-->
<!--            <div>AI_CONFIDENCE: <span id="conf" class="text-white">0%</span></div>-->
<!--            <div>STRESS_LEVEL: <span id="stress-num" class="text-white">0</span></div>-->
<!--            <div>LATENCY: <span class="text-green-500">14MS</span></div>-->
<!--            <button onclick="handleLogout()" class="text-red-500 border border-red-900 px-2 rounded hover:bg-red-900/20 transition-all">-->
<!--                LOG_OUT-->
<!--            </button>-->
<!--        </div>-->
<!--    </header>-->

<!--    <div class="grid grid-cols-12 gap-4 flex-1 min-h-0">-->
<!--        &lt;!&ndash; 左侧：环形仪表盘与数据分布 &ndash;&gt;-->
<!--        <div class="col-span-3 flex flex-col gap-4 min-h-0">-->
<!--            &lt;!&ndash; 情绪仪表盘 &ndash;&gt;-->
<!--            <div class="glass p-4 rounded-3xl h-1/2 flex flex-col neon-border">-->
<!--                <h2 class="text-[10px] font-bold text-cyan-500 mb-2 uppercase">情绪压力仪表盘</h2>-->
<!--                <div id="gauge-chart" class="flex-1"></div>-->
<!--            </div>-->
<!--            &lt;!&ndash; 情绪散点坐标系 &ndash;&gt;-->
<!--            <div class="glass p-4 rounded-3xl h-1/2 flex flex-col neon-border">-->
<!--                <h2 class="text-[10px] font-bold text-cyan-500 mb-2 uppercase">情感极性空间 (Valence/Arousal)</h2>-->
<!--                <div id="scatter-chart" class="flex-1"></div>-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; 中间：主监控区 &ndash;&gt;-->
<!--        <div class="col-span-6 flex flex-col gap-4 min-h-0">-->
<!--            <div class="glass rounded-[3rem] overflow-hidden relative border-2 border-white/5 shadow-2xl bg-black h-2/3">-->
<!--                <div class="scan-effect"></div>-->
<!--                <img src="/video_feed" class="w-full h-full object-cover opacity-80">-->
<!--                <div class="absolute top-8 right-8 text-right font-mono text-[10px] text-cyan-500">-->
<!--                    <p>LIVE_FEED_01</p>-->
<!--                    <p id="timestamp"></p>-->
<!--                </div>-->
<!--            </div>-->
<!--            &lt;!&ndash; 心电图曲线 &ndash;&gt;-->
<!--            <div class="glass p-4 rounded-[2rem] h-1/3 neon-border">-->
<!--                <div id="wave-chart" class="w-full h-full"></div>-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; 右侧：数字矩阵与历史日志 &ndash;&gt;-->
<!--        <div class="col-span-3 flex flex-col gap-4 min-h-0">-->
<!--            <div class="glass p-6 rounded-[2.5rem] flex-1 overflow-y-auto">-->
<!--                <h2 class="text-[10px] font-bold text-cyan-500 mb-6 uppercase tracking-widest">实时数据矩阵</h2>-->
<!--                <div id="bars" class="space-y-5"></div>-->
<!--            </div>-->
<!--            <div class="glass p-4 rounded-[2.5rem] h-[150px] font-mono text-[9px] text-gray-500 overflow-hidden">-->
<!--                <h2 class="text-[10px] text-cyan-800 mb-2 uppercase">系统识别流</h2>-->
<!--                <div id="log-list" class="space-y-1"></div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

<!--    <script>-->
<!--        const emotions = ["喜悦", "平静", "惊讶", "忧伤", "愤怒", "恐惧", "厌恶"];-->

<!--        // 1. 初始化仪表盘 (Stress Gauge)-->
<!--        const gaugeChart = echarts.init(document.getElementById('gauge-chart'));-->
<!--        const gaugeOption = {-->
<!--            series: [{-->
<!--                type: 'gauge',-->
<!--                progress: { show: true, width: 8, itemStyle: { color: '#06b6d4' } },-->
<!--                axisLine: { lineStyle: { width: 8, color: [[1, 'rgba(255,255,255,0.05)']] } },-->
<!--                axisTick: { show: false }, splitLine: { show: false },-->
<!--                axisLabel: { show: false }, anchor: { show: false },-->
<!--                detail: { valueAnimation: true, formatter: '{value}', color: '#fff', fontSize: 24, offsetCenter: [0, '30%'] },-->
<!--                data: [{ value: 0 }]-->
<!--            }]-->
<!--        };-->

<!--        // 2. 初始化散点图 (Emotional Space)-->
<!--        const scatterChart = echarts.init(document.getElementById('scatter-chart'));-->
<!--        const scatterOption = {-->
<!--            grid: { top: 10, bottom: 20, left: 20, right: 20 },-->
<!--            xAxis: { min: -100, max: 100, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }, axisLabel: { show: false } },-->
<!--            yAxis: { min: -100, max: 100, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }, axisLabel: { show: false } },-->
<!--            series: [{-->
<!--                symbolSize: 20,-->
<!--                data: [[0, 0]],-->
<!--                type: 'scatter',-->
<!--                itemStyle: { color: '#06b6d4', shadowBlur: 10, shadowColor: '#06b6d4' },-->
<!--                markLine: { lineStyle: { type: 'solid', color: 'rgba(6,182,212,0.2)' }, data: [{type: 'average'}, {xAxis: 0}, {yAxis: 0}] }-->
<!--            }]-->
<!--        };-->

<!--        // 3. 初始化心电波形图-->
<!--        const waveChart = echarts.init(document.getElementById('wave-chart'));-->
<!--        let waveData = Array(50).fill(0);-->
<!--        const waveOption = {-->
<!--            grid: { inset: 0, top: 10, bottom: 10, left: 0, right: 0 },-->
<!--            xAxis: { type: 'category', show: false },-->
<!--            yAxis: { type: 'value', min: 0, max: 100, show: false },-->
<!--            series: [{-->
<!--                data: waveData, type: 'line', smooth: true, symbol: 'none',-->
<!--                lineStyle: { color: '#06b6d4', width: 2 },-->
<!--                areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset:0, color:'rgba(6,182,212,0.3)'},{offset:1, color:'transparent'}]) }-->
<!--            }]-->
<!--        };-->

<!--        // 初始化进度条-->
<!--        const barsDiv = document.getElementById('bars');-->
<!--        emotions.forEach(e => {-->
<!--            barsDiv.innerHTML += `-->
<!--                <div>-->
<!--                    <div class="flex justify-between text-[10px] mb-1"><span>${e}</span><span id="v-${e}">0%</span></div>-->
<!--                    <div class="w-full bg-white/5 h-1 rounded-full"><div id="b-${e}" class="bg-cyan-500 h-full shadow-[0_0_8px_#06b6d4]" style="width: 0%"></div></div>-->
<!--                </div>`;-->
<!--        });-->

<!--        // 实时数据同步-->
<!--        async function update() {-->
<!--            try {-->
<!--                const res = await fetch('/api/get_data');-->
<!--                const data = await res.json();-->

<!--                document.getElementById('conf').innerText = data.info.confidence + "%";-->
<!--                document.getElementById('timestamp').innerText = new Date().toLocaleString();-->

<!--                // 更新压力仪表盘 (计算 愤怒+厌恶+恐惧 的权重)-->
<!--                const stress = Math.round((data.emotions['愤怒'] + data.emotions['厌恶'] + data.emotions['恐惧']) / 1.5);-->
<!--                gaugeOption.series[0].data[0].value = stress;-->
<!--                gaugeChart.setOption(gaugeOption);-->
<!--                document.getElementById('stress-num').innerText = stress;-->

<!--                // 更新散点图 (计算 Valence/Arousal 坐标)-->
<!--                // 喜悦 = 正/正, 忧伤 = 负/负, 愤怒 = 负/正-->
<!--                const valence = (data.emotions['喜悦'] + data.emotions['惊讶']) - (data.emotions['愤怒'] + data.emotions['忧伤'] + data.emotions['厌恶']);-->
<!--                const arousal = (data.emotions['愤怒'] + data.emotions['惊讶'] + data.emotions['喜悦']) - (data.emotions['平静'] + data.emotions['忧伤']);-->
<!--                scatterOption.series[0].data = [[valence, arousal]];-->
<!--                scatterChart.setOption(scatterOption);-->

<!--                // 更新波形图-->
<!--                waveData.push(Math.max(...Object.values(data.emotions)));-->
<!--                waveData.shift();-->
<!--                waveChart.setOption({ series: [{ data: waveData }] });-->

<!--                // 更新矩阵-->
<!--                emotions.forEach(e => {-->
<!--                    const val = data.emotions[e].toFixed(1);-->
<!--                    document.getElementById(`b-${e}`).style.width = val + "%";-->
<!--                    document.getElementById(`v-${e}`).innerText = val + "%";-->
<!--                });-->

<!--                // 日志流-->
<!--                const topEmo = emotions.reduce((a, b) => data.emotions[a] > data.emotions[b] ? a : b);-->
<!--                if(data.emotions[topEmo] > 20) {-->
<!--                    const log = document.getElementById('log-list');-->
<!--                    const item = document.createElement('div');-->
<!--                    item.innerHTML = `<span class="text-cyan-900">></span> DETECTED_${topEmo}_${data.emotions[topEmo].toFixed(0)}%`;-->
<!--                    log.prepend(item);-->
<!--                    if(log.children.length > 8) log.lastChild.remove();-->
<!--                }-->

<!--            } catch(e) {}-->
<!--        }-->

<!--        gaugeChart.setOption(gaugeOption);-->
<!--        scatterChart.setOption(scatterOption);-->
<!--        waveChart.setOption(waveOption);-->
<!--        setInterval(update, 200);-->

<!--        // 窗口缩放适配-->
<!--        window.onresize = () => {-->
<!--            gaugeChart.resize(); scatterChart.resize(); waveChart.resize();-->
<!--        };-->
<!--        function handleLogout() {-->
<!--        Swal.fire({-->
<!--            title: '确认终止访问?',-->
<!--            text: "当前的生物特征监测链路将被安全切断。",-->
<!--            icon: 'warning',-->
<!--            showCancelButton: true,-->
<!--            confirmButtonColor: '#ef4444', // 红色确认按钮-->
<!--            cancelButtonColor: '#334155',  // 深色取消按钮-->
<!--            confirmButtonText: '确定终止',-->
<!--            cancelButtonText: '保持连接',-->
<!--            background: '#010409',        // 匹配你的仪表盘深色背景-->
<!--            color: '#c9d1d9',             // 匹配文字颜色-->
<!--            backdrop: `rgba(0,0,0,0.8)`   // 加深背景遮罩-->
<!--        }).then((result) => {-->
<!--            if (result.isConfirmed) {-->
<!--                // 如果确认，则跳转到首页-->
<!--                window.location.href = '/';-->
<!--            }-->
<!--        });-->
<!--    }-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->




<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>FaceSense AI // 战术终端</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        body { background: #000; color: #0ff; font-family: 'Share Tech Mono', monospace; overflow: hidden; height: 100vh; margin: 0; }

        /* 玻璃拟态 */
        .hud-panel { background: rgba(2, 6, 23, 0.85); border: 1px solid rgba(6, 182, 212, 0.3); box-shadow: 0 0 15px rgba(6, 182, 212, 0.1); backdrop-filter: blur(4px); position: relative; }
        .hud-panel::before { content: ''; position: absolute; top: -1px; left: -1px; width: 10px; height: 10px; border-top: 2px solid #06b6d4; border-left: 2px solid #06b6d4; }
        .hud-panel::after { content: ''; position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px; border-bottom: 2px solid #06b6d4; border-right: 2px solid #06b6d4; }

        /* 悬浮窗特效 */
        .float-window { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom right; }
        .float-window.hidden-panel { transform: scale(0); opacity: 0; pointer-events: none; }

        .scan-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; background: linear-gradient(to bottom, transparent 50%, rgba(6, 182, 212, 0.1) 51%, transparent 51%); background-size: 100% 4px; animation: scanline 10s linear infinite; }
        .alert-mode { border-color: #ef4444 !important; box-shadow: 0 0 30px rgba(239, 68, 68, 0.4) !important; animation: alertPulse 1s infinite; }
        @keyframes alertPulse { 0% { box-shadow: inset 0 0 0 rgba(239,68,68,0); } 50% { box-shadow: inset 0 0 50px rgba(239,68,68,0.3); } 100% { box-shadow: inset 0 0 0 rgba(239,68,68,0); } }
        .no-scrollbar::-webkit-scrollbar { width: 4px; }
        .no-scrollbar::-webkit-scrollbar-thumb { background: #06b6d4; border-radius: 4px; }
        #particles-js { position: absolute; width: 100%; height: 100%; z-index: -1; }
    </style>
</head>
<body class="p-4 flex flex-col h-screen relative">
    <div id="particles-js"></div>

    <!-- 顶栏 -->
    <header class="hud-panel p-3 rounded-t-lg flex justify-between items-center px-6 mb-3">
        <div class="flex items-center gap-4">
            <div id="sys-status" class="w-3 h-3 bg-cyan-500 rounded-full shadow-[0_0_10px_#06b6d4]"></div>
            <h1 class="text-2xl font-bold tracking-[0.3em] text-white">FACESENSE<span class="text-cyan-400 text-sm ml-2">// SENTIENCE_LINK</span></h1>
        </div>
        <div class="flex gap-8 font-mono text-xs text-cyan-200/70">
            <div class="flex flex-col items-end"><span>CPU_THREAD</span><span class="text-white text-lg font-bold" id="cpu-val">--%</span></div>
            <div class="flex flex-col items-end"><span>SESSION_TIME</span><span class="text-white text-lg font-bold" id="timer">00:00:00</span></div>
            <button onclick="handleLogout()" class="border border-red-500/50 text-red-500 px-4 hover:bg-red-500 hover:text-white transition uppercase text-xs tracking-widest">Abort</button>
        </div>
    </header>

    <div class="grid grid-cols-12 gap-4 flex-1 min-h-0">
        <!-- 左侧 -->
        <div class="col-span-3 flex flex-col gap-4">
            <div class="hud-panel p-4 h-1/3 flex flex-col" id="panel-stress"><div id="gauge-chart" class="flex-1"></div></div>
            <div class="hud-panel p-4 h-1/3 flex flex-col"><div id="radar-chart" class="flex-1"></div></div>
            <div class="hud-panel p-4 h-1/3 flex flex-col"><div id="wave-chart" class="flex-1"></div></div>
        </div>

        <!-- 中间：全屏视频 -->
        <div class="col-span-6 flex flex-col gap-4 relative">
            <div class="hud-panel flex-1 relative overflow-hidden bg-black/80" id="video-container">
                <div class="scan-overlay"></div>
                <div class="absolute inset-4 border border-cyan-500/30 pointer-events-none"></div>
                <div class="absolute top-4 left-4 text-xs text-cyan-500 font-mono">LIVE_FEED // ACTIVE</div>
                <img src="/video_feed" class="w-full h-full object-cover opacity-90">
            </div>
        </div>

        <!-- 右侧 -->
        <div class="col-span-3 flex flex-col gap-4">
            <div class="hud-panel p-5 h-2/3 overflow-y-auto no-scrollbar"><div id="bars" class="space-y-6"></div></div>
            <div class="hud-panel p-4 h-1/3 flex flex-col bg-black"><div id="log-list" class="flex-1 overflow-y-auto no-scrollbar font-mono text-[9px] space-y-1 text-gray-500"></div></div>
        </div>
    </div>

    <!-- ================= 悬浮 AI 终端 ================= -->
    <!-- 1. 悬浮窗体 -->
    <div id="ai-window" class="fixed bottom-20 right-6 w-80 h-96 hud-panel flex flex-col p-0 z-50 float-window hidden-panel shadow-[0_0_50px_rgba(6,182,212,0.2)]">
        <!-- 标题栏 -->
        <div class="bg-cyan-900/30 p-2 flex justify-between items-center border-b border-cyan-700">
            <span class="text-xs font-bold text-cyan-300">SENTIENCE AI CORE</span>
            <button onclick="toggleAI()" class="text-cyan-500 hover:text-white">✕</button>
        </div>
        <!-- 聊天记录 -->
        <div id="chat-history" class="flex-1 overflow-y-auto no-scrollbar p-3 space-y-3 font-mono text-xs bg-black/80">
            <div class="text-cyan-600">[SYSTEM] 神经网络连接就绪...</div>
        </div>
        <!-- 输入区 -->
        <div class="p-2 border-t border-cyan-800 bg-black/90 flex gap-2">
            <input type="text" id="chat-input" placeholder="输入指令..." class="flex-1 bg-transparent border-b border-cyan-700 text-cyan-100 text-xs px-1 py-1 focus:outline-none focus:border-cyan-400 font-mono" onkeypress="if(event.keyCode==13) sendChat()">
            <button onclick="sendChat()" class="text-cyan-400 text-xs hover:text-white border border-cyan-700 px-2 rounded hover:bg-cyan-700">SEND</button>
        </div>
    </div>

    <!-- 2. 悬浮开关按钮 -->
    <button onclick="toggleAI()" class="fixed bottom-6 right-6 w-12 h-12 rounded-full bg-cyan-900/80 border-2 border-cyan-500 text-cyan-400 flex items-center justify-center hover:bg-cyan-500 hover:text-black hover:shadow-[0_0_20px_#06b6d4] transition-all z-50 group">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 animate-pulse group-hover:animate-none">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
        </svg>
    </button>

    <script>
        // 粒子背景
        particlesJS("particles-js", { "particles": { "number": { "value": 40 }, "color": { "value": "#06b6d4" }, "opacity": { "value": 0.2 }, "size": { "value": 2 }, "line_linked": { "enable": true, "color": "#06b6d4", "opacity": 0.1 } } });
        const emotions = ["喜悦", "平静", "惊讶", "忧伤", "愤怒", "恐惧", "厌恶"];
        let startTime = Date.now();

        // 悬浮窗开关逻辑
        function toggleAI() {
            const win = document.getElementById('ai-window');
            win.classList.toggle('hidden-panel');
            if(!win.classList.contains('hidden-panel')) {
                document.getElementById('chat-input').focus();
            }
        }

        // AI 聊天逻辑
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML += `<div class="text-right mb-2"><span class="bg-cyan-900/50 text-cyan-100 px-2 py-1 rounded inline-block text-left">${text}</span></div>`;
            input.value = "";
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const loadingId = "loading-" + Date.now();
            chatHistory.innerHTML += `<div id="${loadingId}" class="text-left text-cyan-500 text-[10px] mb-2"><span class="animate-pulse">Analyzing...</span></div>`;

            try {
                const formData = new FormData();
                formData.append('message', text);
                const res = await fetch('/api/chat', { method: 'POST', body: formData });
                const data = await res.json();

                document.getElementById(loadingId).remove();
                if (data.status === 'success') {
                    const replyDiv = document.createElement('div');
                    replyDiv.className = "text-left text-green-400 mb-3 max-w-[95%]";
                    chatHistory.appendChild(replyDiv);
                    typeWriter(replyDiv, `[AI]: ${data.reply}`);
                } else {
                    chatHistory.innerHTML += `<div class="text-red-500 mb-2">[ERR]: ${data.message}</div>`;
                }
            } catch (e) {
                document.getElementById(loadingId).remove();
                chatHistory.innerHTML += `<div class="text-red-500 mb-2">[LINK_LOST]</div>`;
            }
        }

        function typeWriter(element, text, index = 0) {
            if (index < text.length) {
                element.innerHTML += text.charAt(index);
                document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
                setTimeout(() => typeWriter(element, text, index + 1), 20);
            }
        }

        // 图表初始化
        const gaugeChart = echarts.init(document.getElementById('gauge-chart'));
        const gaugeOption = { series: [{ type: 'gauge', min:0, max:100, splitNumber:5, progress: { show: true, width: 5, itemStyle: { color: '#06b6d4' } }, axisLine: { lineStyle: { width: 5, color: [[1, '#1e293b']] } }, axisTick: { show: false }, splitLine: { length: 5, lineStyle: {width: 1, color: '#999'} }, axisLabel: { show: false }, pointer: { itemStyle: { color: '#fff' } }, detail: { valueAnimation: true, formatter: '{value}%', color: '#fff', fontSize: 16, offsetCenter: [0, '70%'] }, data: [{ value: 0 }] }] };
        const radarChart = echarts.init(document.getElementById('radar-chart'));
        const radarOption = { radar: { indicator: emotions.map(e => ({ name: e, max: 100 })), splitArea: { areaStyle: { color: ['rgba(6,182,212,0.1)', 'rgba(6,182,212,0.05)'] } }, axisLine: { lineStyle: { color: 'rgba(6,182,212,0.3)' } }, splitLine: { lineStyle: { color: 'rgba(6,182,212,0.3)' } }, axisName: { color: '#06b6d4', fontSize: 10 } }, series: [{ type: 'radar', data: [{ value: [0,0,0,0,0,0,0], name: 'Emotion' }], symbol: 'none', lineStyle: { width: 1, color: '#00ffff' }, areaStyle: { color: 'rgba(0,255,255,0.2)' } }] };
        const waveChart = echarts.init(document.getElementById('wave-chart'));
        let waveData = Array(50).fill(0);
        const waveOption = { grid: { top: 5, bottom: 5, left: 0, right: 0 }, xAxis: { type: 'category', show: false }, yAxis: { type: 'value', min: 0, max: 100, show: false }, series: [{ data: waveData, type: 'line', smooth: true, symbol: 'none', lineStyle: { color: '#ef4444', width: 2 }, areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(239,68,68,0.3)'},{offset:1,color:'transparent'}]) } }] };

        const barsDiv = document.getElementById('bars');
        emotions.forEach(e => { barsDiv.innerHTML += `<div class="group"><div class="flex justify-between text-[10px] mb-1 font-mono text-cyan-200"><span>${e.toUpperCase()}</span><span id="v-${e}">0.0</span></div><div class="w-full bg-slate-800 h-1 overflow-hidden relative"><div id="b-${e}" class="bg-cyan-500 h-full transition-all duration-300 relative group-hover:shadow-[0_0_10px_#06b6d4]" style="width: 0%"></div></div></div>`; });

        // 数据同步循环
        async function update() {
            try {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').innerText = new Date(elapsed * 1000).toISOString().substr(11, 8);
                const res = await fetch('/api/get_data');
                const data = await res.json();
                document.getElementById('cpu-val').innerText = (data.info.fps || 30) + "FPS";
                const stress = Math.round((data.emotions['愤怒'] + data.emotions['厌恶'] + data.emotions['恐惧'] * 1.5) / 1.8);
                gaugeOption.series[0].data[0].value = stress; gaugeChart.setOption(gaugeOption);

                // 红色警戒
                const videoContainer = document.getElementById('video-container');
                if (stress > 60) { videoContainer.classList.add('alert-mode'); document.getElementById('sys-status').className = "w-3 h-3 bg-red-500 rounded-full animate-ping"; }
                else { videoContainer.classList.remove('alert-mode'); document.getElementById('sys-status').className = "w-3 h-3 bg-cyan-500 rounded-full shadow-[0_0_10px_#06b6d4]"; }

                const radarValues = emotions.map(e => data.emotions[e]);
                radarOption.series[0].data[0].value = radarValues; radarChart.setOption(radarOption);
                waveData.push(Math.max(...Object.values(data.emotions))); waveData.shift(); waveChart.setOption({ series: [{ data: waveData }] });

                emotions.forEach(e => {
                    const val = data.emotions[e];
                    document.getElementById(`b-${e}`).style.width = val + "%";
                    document.getElementById(`v-${e}`).innerText = val.toFixed(1);
                    const bar = document.getElementById(`b-${e}`);
                    if (val > 80) bar.style.backgroundColor = '#ef4444'; else if (val > 40) bar.style.backgroundColor = '#eab308'; else bar.style.backgroundColor = '#06b6d4';
                });
                const topEmo = emotions.reduce((a, b) => data.emotions[a] > data.emotions[b] ? a : b);
                if (data.emotions[topEmo] > 20) { addLog(`DETECTED > ${topEmo} [${data.emotions[topEmo].toFixed(0)}%]`, 'text-cyan-600'); }
            } catch(e) {}
        }

        function addLog(msg, colorClass='text-gray-500') {
            const log = document.getElementById('log-list');
            const item = document.createElement('div');
            item.className = `${colorClass} truncate`;
            item.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString('en-GB')}]</span> ${msg}`;
            log.prepend(item);
            if(log.children.length > 15) log.lastChild.remove();
        }

        gaugeChart.setOption(gaugeOption); radarChart.setOption(radarOption); waveChart.setOption(waveOption);
        setInterval(update, 200);
        window.onresize = () => { gaugeChart.resize(); radarChart.resize(); waveChart.resize(); };
        function handleLogout() { Swal.fire({ title: 'LOGOUT?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', background: '#000', color: '#fff' }).then((r) => { if (r.isConfirmed) window.location.href = '/'; }); }
    </script>
</body>
</html>